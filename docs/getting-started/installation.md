# Installation Guide

This guide is for a Windows 11 environment.

### WSL2 Setup (Ubuntu 22.04 LTS)

Open PowerShell as administrator and install Ubuntu-22.04.

``` PowerShell
wsl --install -d Ubuntu-22.04
```

Open WSL.

``` PowerShell
wsl -d Ubuntu-22.04
```

Install the essentials.

``` bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y build-essential cmake git
```

### Install PX4

Read [PX4 ROS2 User Guide](#additional-resources) for more details.

``` bash
cd ~
git clone https://github.com/PX4/PX4-Autopilot.git --recursive
bash ./PX4-Autopilot/Tools/setup/ubuntu.sh
cd PX4-Autopilot/
make px4_sitl
```

If you get this error regarding protoc, you must download and compile protoc 3.6.1 from source manually. Otherwise, skip this section. (Referenced from ["Protoc error on build"](#additional-resources) forum post on discuss.px4.io).

```
/usr/include/gz/msgs10/gz/msgs/details/serialized.pb.h:12:2: error: #error This file was generated by a newer version of protoc which is
   12 | #error This file was generated by a newer version of protoc which is
      |  ^~~~~
```

Remove existing Protobuf version.

``` bash 
sudo apt-get remove --purge protobuf-compiler libprotobuf-dev
sudo apt-get autoremove
```

Download and compile protoc 3.6.1 from source.

``` bash
cd ~
wget https://github.com/protocolbuffers/protobuf/releases/download/v3.6.1/protobuf-all-3.6.1.tar.gz
tar -xzf protobuf-all-3.6.1.tar.gz
cd protobuf-3.6.1
./configure --prefix=/usr/local
make -j$(nproc)
sudo make install
sudo ldconfig
```

Verify installation (it should be 3.6.1 now).

``` bash
protoc --version
```

Clean PX4 project directory.

``` bash
cd ~/PX4-Autopilot
make distclean
```

Restart WSL

``` bash
exit
```
Shutdown.

``` PowerShell
wsl --shutdown
```

Wait a few seceonds then open a new WSL terminal.

``` PowerShell
wsl -d Ubuntu-22.04
```

Try the build again:

``` bash
cd ~/PX4-Autopilot/
make px4_sitl
```

### Install ROS2

Install ROS2 Humble on Ubuntu 22.04.

``` bash
cd ~
sudo apt update && sudo apt install locales
sudo locale-gen en_US en_US.UTF-8
sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
export LANG=en_US.UTF-8
sudo apt install software-properties-common
sudo add-apt-repository universe
sudo apt update && sudo apt install curl -y
sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list > /dev/null
sudo apt update && sudo apt upgrade -y
sudo apt install ros-humble-desktop
sudo apt install ros-dev-tools
source /opt/ros/humble/setup.bash && echo "source /opt/ros/humble/setup.bash" >> .bashrc
```

Install some missing dependencies.

``` bash
pip install --user -U empy==3.3.4 pyros-genmsg setuptools
```

### Setup Micro XRCE-DSS

uXRCE-DDS allows the PX4 flight controller to natively participate in a ROS2 DDS network. The client runs on PX4, which communicates with an agent on the ROS2 companion computer.

``` bash
cd ~
git clone -b v2.4.3 https://github.com/eProsima/Micro-XRCE-DDS-Agent.git
cd Micro-XRCE-DDS-Agent
mkdir build
cd build
cmake ..
make
sudo make install
sudo ldconfig /usr/local/lib/
cd ~
```

Start the agent.

``` bash
MicroXRCEAgent udp4 -p 8888
```

### AirSim Setup

For this project we will be using [Cosys-AirSim](https://cosys-lab.github.io/Cosys-AirSim/) as our simulator, a similar set up can be accomplished with other simulators like Gazebo. Cosys-AirSim comes with a ROS2 wrapper that will allow us to read sensor data from the simulator.

1. Install Cosys-AirSim

2. Configure AirSim plugin for PX4

Most connection issues between UE5 on your local windows machine and the flight controller in WSL2 can be fixed by adding inbound rules to the connection ports and to UE5.

Add inbound rules for `TCP 4560`, `UDP 14540`, and `Unreal Engine`.

### Download Template Source Code



### Run Order

Run these commands in seperate terminals.

1. Cosys-AirSim (Windows)
Start simulator first, PX4 will connect via UDP 14540

2. uXRCE-DDS (WSL2)
``` bash
MicroXRCEAgent udp4 -p 8888
```

3. PX4 SITL (WSL2)

``` bash
cd ~/PX4-Autopilot
make px4_sitl none_iris
```

4. AirSim ROS2 Wrapper (WSL2)


### Additional Resources

- [PX4 ROS2 User Guide](https://docs.px4.io/main/en/ros2/user_guide)
- [Protoc error on build](https://discuss.px4.io/t/protoc-error-on-build/44661)
- [Cosys-AirSim Docs](https://cosys-lab.github.io/Cosys-AirSim/)

